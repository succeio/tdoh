<script setup>
import { database } from '../firebase'
import { ref as dbRef, update, onValue, get, push, remove } from 'firebase/database'
import { computed, ref, inject, onMounted, onBeforeUnmount, watchEffect} from 'vue'
import { useRoute } from 'vue-router';
import { VueShowdown } from 'vue-showdown'

const getPostId = inject('getPostId')

//---------- router
const route = useRoute();
//----------- router

const props = defineProps({
  id: Number,
  theme: String,
  time: String,
  data: String,
  name: String,
  url: String,
  mimeType: String,
  text: String,
  password: String,
  day: String,
  threadId: String,
  postId: String,
  replies: Array
})

//  route.params.board, route.params.thread
const prms = ref('')
const keys = ref([])
const root = localStorage.getItem('xf')

const pin = async (threadId) => {
  prms.value = await hashString(localStorage.getItem('xf'))
  prms.value = await hashString(prms.value)

  const keyRef = dbRef(database, `xf/xx/-O8pvIYAqJwO5UCMrbwv`)

   onValue(keyRef, (snapshot) => {
    const data = snapshot.val()
    keys.value = Object.values(data)
   }) 
  
  if (keys.value[0] == prms.value) {
    const postRef = dbRef(database, `${route.params.board}/${threadId}/op`)
    const snapshot = await get(dbRef(database, `${route.params.board}/${threadId}`))
    if (snapshot.exists()) {
      const data = snapshot.val()
      if (data.lastPostTimestamp !== 9999999999999) {
        console.log(data.lastPostTimestamp)
        await update(dbRef(database, `${route.params.board}/${threadId}`), {
          lastPostTimestamp: 9999999999999 
        })
        await update(postRef, {
          time: "PINNED"
        })        
      } else {
        await update(dbRef(database, `${route.params.board}/${threadId}`), {
          lastPostTimestamp: Date.now()
        })
          await update(postRef, {
          time: "00:00:00"
        })        
      }
    }
  }
}

const del = async (threadId, postId) => {
  prms.value = await hashString(localStorage.getItem('xf'))
  prms.value = await hashString(prms.value)

  const keyRef = dbRef(database, `xf/xx/-O8pvIYAqJwO5UCMrbwv`)

   onValue(keyRef, (snapshot) => {
    const data = snapshot.val()
    keys.value = Object.values(data)
   }) 

  if (keys.value[0] == prms.value){
    const postRef = dbRef(database, `${route.params.board}/${threadId}/posts/${postId}`)
    update(postRef, { text: '*–ü–æ—Å—Ç –±—ã–ª –∏–∑—ä—è—Ç.*'})
    update(postRef, { url: ''})
    update(postRef, { theme: ''})
    update(postRef, { name: '–ê–Ω–æ–Ω–∏–º'})
    update(postRef, { password: ''})
    console.log('OK')    
  } else {
    console.log('DENIED')
  }
}

const dAll = async (threadId, postId) => {
  try {
    // –ü–æ–ª—É—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–æ—Å–∫–∏ –∏ —Ö—ç—à–∏—Ä—É–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã
    prms.value = await hashString(localStorage.getItem('xf'));
    prms.value = await hashString(prms.value);

    // –ü–æ–ª—É—á–∞–µ–º –∫–ª—é—á–∏
    const keyRef = dbRef(database, `xf/xx/-O8pvIYAqJwO5UCMrbwv`);
    const keySnapshot = await get(keyRef);
    const keys = keySnapshot.exists() ? Object.values(keySnapshot.val()) : [];

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å–æ–≤–ø–∞–¥–∞–µ—Ç –ª–∏ –ø–µ—Ä–≤—ã–π –∫–ª—é—á —Å –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
    if (keys[0] !== prms.value) {
      console.log('DENIED');
      return;
    }

    // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ –ø–æ postId
    const postRef = dbRef(database, `${route.params.board}/${threadId}/posts/${postId}`);
    const postSnapshot = await get(postRef);

    if (postSnapshot.exists()) {
      const postData = postSnapshot.val();
      const uId = postData.uId; // –ü–æ–ª—É—á–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ –∫–ª—é—á—É 'uId'

      // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ –ø–æ—Å—Ç—ã –ø–æ threadId
      const postsRef = dbRef(database, `${route.params.board}/${threadId}/posts/`);
      const postsSnapshot = await get(postsRef);

      if (postsSnapshot.exists()) {
        const posts = postsSnapshot.val();

        // –ü—Ä–æ—Ö–æ–¥–∏–º –ø–æ –≤—Å–µ–º –ø–æ—Å—Ç–∞–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º —Ç–µ, —É –∫–æ—Ç–æ—Ä—ã—Ö —Å–æ–≤–ø–∞–¥–∞–µ—Ç uId
        for (const id in posts) {
          if (posts[id].uId === uId) {
            const updateRef = dbRef(database, `${route.params.board}/${threadId}/posts/${id}`);
              await remove(updateRef)
          }
        }

        //–∑–∞–Ω–æ—Å–∏–º uId –≤ –±–∞–Ω
        const expirationTime = Date.now() + 24 * 60 * 60 * 1000; // 1 –¥–µ–Ω—å –≤ –º–∏–ª–ª–∏—Å–µ–∫—É–Ω–¥–∞—Ö
        const banData = {
          uId: uId,
          exp: expirationTime
        };
        
        await push(dbRef(database, `banned/${route.params.board}/uIds`), banData)

      } else {
        console.log("–ü–æ—Å—Ç—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
      }
    } else {
      console.log("–î–∞–Ω–Ω—ã–µ –ø–æ—Å—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã");
    }
  } catch (error) {
    console.error("–û—à–∏–±–∫–∞:", error);
  }
};

const hashString = async (input) => {
  const encoder = new TextEncoder()
  const data = encoder.encode(input)
  const hashBuffer = await crypto.subtle.digest('SHA-256', data)
  const hashArray = Array.from(new Uint8Array(hashBuffer))
  const hashHex = hashArray.map((b) => b.toString(16).padStart(2, '0')).join('')
  return hashHex.substring(8, 16)
}

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å—Å—ã–ª–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º
const isImage = computed(() => {
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ 'image' –≤ URL

  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ props.mimeType –ø–µ—Ä–µ–¥ –≤—ã–∑–æ–≤–æ–º startsWith
  const isMimeTypeImage = props.mimeType && typeof props.mimeType === 'string' && props.mimeType.startsWith('image/');
  
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ props.url —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏ —è–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–æ–π
  const isUrlImage = props.url && typeof props.url === 'string' && /\.(jpeg|jpg|gif|png)$/i.test(props.url);
  
  return isMimeTypeImage || isUrlImage;
});

const isVideo = computed(() => {
   // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ MIME-—Ç–∏–ø—É –∏ —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—é —Ñ–∞–π–ª–∞
  const isMimeTypeVideo = props.mimeType && typeof props.mimeType === 'string' && props.mimeType.startsWith('video/');
  const isUrlVideo = props.url && typeof props.url === 'string' && /\.(mp4|webm|ogg)$/i.test(props.url);

  return isMimeTypeVideo || isUrlVideo;
});


const isSoundCloud = computed(() => {
  return /api\.soundcloud\.com/i.test(props.url);  
})

const scLink = ref('')
scLink.value = props.url.match(/(api\.soundcloud\.com\/tracks\/\d+)/i) ? props.url.match(/(api\.soundcloud\.com\/tracks\/\d+)/i) : ''

// –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–¥–µ—Ä–∂–∏—Ç –ª–∏ —Å—Ç—Ä–æ–∫–∞ youtube.com
const isYouTube = computed(() => {
  return props.url ? props.url.includes('youtube.com') : false
})
const ytLink = ref('')
ytLink.value = props.url.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/i) ? props.url.match(/(?:https?:\/\/)?(?:www\.)?youtube\.com\/watch\?v=([a-zA-Z0-9_-]+)/i)[1] : '';


const passwordMap = ref([{ password: '6da027bf', value: 'üçáüåöüç§coyc' }])

// –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –ø–∞—Ä–æ–ª—è
const isPasswordMatched = computed(() => {
  return passwordMap.value.some((item) => item.password === props.password)
})

// –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –ø–∞—Ä–æ–ª—è
const displayValue = computed(() => {
  const matchedItem = passwordMap.value.find((item) => item.password === props.password)
  return matchedItem ? matchedItem.value : '!' + props.password
})

// –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –∫ —ç–ª–µ–º–µ–Ω—Ç—É —Å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–º id
const scrollToElement = (id) => {
  const element = document.getElementById(id)
  if (element) {
    element.scrollIntoView({ behavior: 'smooth' })

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    element.classList.add('glow-purple')

    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      element.classList.remove('glow-purple')
    }, 2000)

  }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞–∑–±–æ—Ä–∞ —Ç–µ–∫—Å—Ç–∞ –∏ –≤—ã–¥–µ–ª–µ–Ω–∏—è —Å—Å—ã–ª–æ–∫
const splitTextWithLinks = computed(() => {
  if (!props.text) return []

  const parts = props.text.split(/(#[A-Za-z0-9_-]+)/g) // –†–∞–∑–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –ø–æ —à–∞–±–ª–æ–Ω—É #ID
  return parts.map((part) => {
    if (part.startsWith('#')) {
      const id = part.substring(1) // –£–¥–∞–ª—è–µ–º —Å–∏–º–≤–æ–ª #
      return { isLink: true, text: part, id }
    } else {
      return { isLink: false, text: part }
    }
  })
})

const repl = (id) => {
  setTimeout(() => {
    const element = document.getElementById(id)
    if (element) {
      const elementPosition = element.getBoundingClientRect().top + window.scrollY
      window.scrollTo({
        top: elementPosition,
        behavior: 'smooth'
      })


    // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –ø–æ–¥—Å–≤–µ—Ç–∫–∏
    element.classList.add('glow-purple')

    // –£–±–∏—Ä–∞–µ–º –ø–æ–¥—Å–≤–µ—Ç–∫—É —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
    setTimeout(() => {
      element.classList.remove('glow-purple')
    }, 2000)


    } else {
      console.warn(`Element with id "${id}" not found.`)
    }
  }, 100)
}

// –î–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–∑–∏—Ü–∏–µ–π –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –ø–æ—Å—Ç–∞
const hoverPost = ref(null)
const tooltipPosition = ref({ top: 0, left: 0 })

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –ø–æ—Å—Ç–∞ –ø—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏
const showPostPreview = (event, postId) => {
  const element = document.getElementById(postId) // –ò—â–µ–º —ç–ª–µ–º–µ–Ω—Ç –ø–æ id
  if (element) {
    const postData = element.querySelector('#postData') // –ù–∞—Ö–æ–¥–∏–º —ç–ª–µ–º–µ–Ω—Ç —Å id="postData"
    const postCore = element.querySelector('#postCore')
    if (postData) {
      // –ò–∑–≤–ª–µ–∫–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤–Ω—É—Ç—Ä–∏ postData
      const postTheme = postData.querySelector('#post-theme')?.innerText || ' '
      const postName = postData.querySelector('#post-name')?.innerText || ' '
      const postPasscode = postData.querySelector('#post-passcode')?.innerText || ' '
      const postTime = postData.querySelector('#post-time')?.innerText || ' '
      const postDate = postData.querySelector('#post-date')?.innerText || ' '

      // –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤—Å–µ—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ —Å data-post-text
      const postTextElements = postCore.querySelectorAll('[data-post-text]')
      const postText =
        Array.from(postTextElements)
          .map((el) => el.innerText.trim()) // –ò–∑–≤–ª–µ–∫–∞–µ–º –∏ –æ—á–∏—â–∞–µ–º —Ç–µ–∫—Å—Ç
          .filter((text) => text.length > 0) // –§–∏–ª—å—Ç—Ä—É–µ–º –ø—É—Å—Ç—ã–µ —Ç–µ–∫—Å—Ç—ã
          .join(' ') || '' // –û–±—ä–µ–¥–∏–Ω—è–µ–º –≤—Å–µ —Ç–µ–∫—Å—Ç—ã –≤ –æ–¥–∏–Ω

      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ hoverPost –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ —Ç—É–ª—Ç–∏–ø–µ
      hoverPost.value = {
        postId,
        theme: postTheme,
        text: postText,
        name: postName,
        time: postTime,
        data: postDate,
        passcode: postPasscode
      }

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–∑–∏—Ü–∏—é —Ç—É–ª—Ç–∏–ø–∞ —Ä—è–¥–æ–º —Å –∫—É—Ä—Å–æ—Ä–æ–º
      tooltipPosition.value = { top: event.clientY + 10, left: event.clientX + 10 }
    } else {
      console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å id "postData" –Ω–µ –Ω–∞–π–¥–µ–Ω –≤–Ω—É—Ç—Ä–∏ –ø–æ—Å—Ç–∞ —Å id ${postId}.`)
    }
  } else {
    //console.warn(`–≠–ª–µ–º–µ–Ω—Ç —Å id ${postId} –Ω–µ –Ω–∞–π–¥–µ–Ω.`)
  }
}

const hidePostPreview = () => {
  hoverPost.value = null
}

const updateTooltipPosition = (event) => {
  tooltipPosition.value = { top: event.clientY + 10, left: event.clientX + 10 }
}


// –ü—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∏ –¥–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
onMounted(() => {
  checkScreenSize();
  window.addEventListener('resize', checkScreenSize);
  window.addEventListener('mousemove', updateTooltipPosition);
});

// –ü—Ä–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ —É–¥–∞–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
onBeforeUnmount(() => {
  window.removeEventListener('resize', checkScreenSize);
  window.removeEventListener('mousemove', updateTooltipPosition);
});

const isEnlarged = ref(false); // Using the Composition API

const videoElement = ref(null); // –†–µ—Ñ–µ—Ä–µ–Ω—Å –Ω–∞ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç

// const toggleImageSize = () => {
//   isEnlarged.value = !isEnlarged.value; // Toggle the state

//     if (videoElement.value) {
//     if (!isEnlarged.value) {
//       videoElement.value.play();  // –í–æ—Å–ø—Ä–æ–∏–∑–≤–æ–¥–∏–º, –µ—Å–ª–∏ —É–≤–µ–ª–∏—á–µ–Ω–æ
//     } else {
//       videoElement.value.pause(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º, –µ—Å–ª–∏ —É–º–µ–Ω—å—à–µ–Ω–æ
//     }
//   }
// };

const toggleImageSize = async () => {
  isEnlarged.value = !isEnlarged.value; // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  const video = videoElement.value; // –ü–æ–ª—É—á–∞–µ–º –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç

  if (!video) {
    //console.error("Video element is null");
    return; // –ï—Å–ª–∏ –≤–∏–¥–µ–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –Ω–µ—Ç, –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º
  }

  if (!isEnlarged.value) {
    try {
      await video.play(); // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–∏–¥–µ–æ
    } catch (error) {
      if (error.name === 'AbortError') {
        console.warn('Video play request was interrupted.');
      } else {
        console.error('Error playing video:', error);
      }
    }
  } else {
    video.pause(); // –ü—Ä–∏ —Å–≤–æ—Ä–∞—á–∏–≤–∞–Ω–∏–∏ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ
  }
};

const handleVideoEnded = () => {
  isEnlarged.value = false; // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–µ
  const video = videoElement.value;
  
  if (video) {
    video.pause(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–∏–¥–µ–æ
  }
};


const isMobile = ref(false); // –§–ª–∞–≥ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤

// –ü—Ä–æ–≤–µ—Ä–∫–∞ —à–∏—Ä–∏–Ω—ã —ç–∫—Ä–∞–Ω–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
const checkScreenSize = () => {
  isMobile.value = window.innerWidth <= 640; // –ú–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –µ—Å–ª–∏ <= 640px
};

// –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —ç–∫—Ä–∞–Ω–∞
watchEffect(() => {
  checkScreenSize();
});

</script>

<template>
  <div
    :id="postId"
    class=" max-w-fit w-full sm:w-auto mt-2 bg-zinc-200 dark:text-zinc-200 p-2 rounded-2xl dark:bg-zinc-900" 
    :class="{
      'sm:w-2/3': props.text.length > 150,
      'ml-2': props.id !== 0,
      'border-twitch border-l-2 dark:border-twitch dark:border-l-2': props.id === 0
    }"
  >
    <div id="postData" class="flex flex-wrap gap-1 text-sm sm:text-base">
      <p id="post-theme" class="font-sans font-bold">{{ theme }}</p>
      <p
        id="post-name"
        :class="{
          'text-twitch': props.password === '73fd4da4',
          'font-bold': props.password === '73fd4da4'
        }"
      >
        {{ name }}
      </p>
      <p
        id="post-passcode"
        v-if="props.password"
        :class="{ 'text-twitch': isPasswordMatched, 'font-bold': isPasswordMatched }"
      >
        {{ displayValue }}
      </p>
      <p id="post-time">{{ time === 'PINNED' ? '00:00:00' : time }}</p>
      <p v-if="props.day">{{ day }}</p>
      <p id="post-date">{{ data }}</p>
      <p @click="getPostId(postId)" class="hover:text-twitch cursor-pointer">
        #{{ postId ? postId.slice(12, 20) : postId }}
      </p>
      <p class="hover:text-twitch cursor-pointer text-green-600">
        {{ id === 0 ? '' : id }}
      </p>

      <p
        v-if="time === 'PINNED'"
        class=""
      >
        <img
          src="../assets/pin.svg"
          alt="Icon"
          class="h-5 w-5 dark:rounded-2xl dark:bg-twitch select-none"
        />
      </p>

      <p
        v-if="id === 0 && !route.params.thread"
        
        
        class="hover:cursor-pointer"
      >
      <router-link :to="`/${route.params.board}/${props.threadId}`">
        <img
          src="../assets/right-circle.svg"
          alt="Icon"
          class="h-5 w-5 dark:rounded-2xl dark:bg-twitch"
        />
      </router-link>
      </p>
      <p
        v-show="root"
        @click="del(props.threadId, props.postId)"
        class="font-bold hover:cursor-pointer hover:text-red-600"
      >
        X
      </p>
      <p
        v-show="root"
        @click="dAll(props.threadId, props.postId)"
        class="font-bold hover:cursor-pointer hover:text-red-600"
      >
        F
      </p>
      <p
        v-show="root"
        v-if="id === 0"
        @click="pin(props.threadId)"
        class="font-bold hover:cursor-pointer hover:text-red-600"
      >
        P
      </p>      
    </div>

    <div class="gap-2 flex flex-col sm:flex-row">
      <div v-show="props.url"  class="gap-2 mt-2 relative">
  <img
    v-if="isImage"
    :class="[ 
      'transition-all duration-150 bg-white rounded-2xl cursor-pointer',
      //isEnlarged ? 'w-80 sm:max-w-2xl' : 'w-48 sm:max-w-xs'
      isEnlarged ? 'w-full sm:max-w-2xl' : 'w-48 sm:max-w-xs'
    ]"
    :src="url"
    alt="post-pic"
    @click="toggleImageSize"
  />

  <video
    v-if="isVideo"
    ref="videoElement"  
    :class="[
      'transition-all duration-150 bg-white rounded-2xl cursor-pointer',
      isEnlarged ? 'w-full sm:max-w-2xl' : 'w-full sm:max-w-xs'
    ]"
    :src="url"
    controls
    volume="0.1"
    @click="toggleImageSize"
    @ended="handleVideoEnded"
  ></video>

        <iframe
          class="rounded-2xl w-full"
          v-if="isSoundCloud"
          height="200"
          scrolling="no"
          frameborder="no"
          allow="autoplay"
          :src="`https://w.soundcloud.com/player/?url=https%3A//${scLink[0]}&color=%23ff5500&auto_play=false&hide_related=false&show_comments=true&show_user=true&show_reposts=false&show_teaser=true&visual=true`"
        ></iframe>

        <iframe
          class="rounded-2xl w-full"
          v-if="isYouTube"
          width="100%"
          height="200"
          :src="`https://www.youtube.com/embed/${ytLink}`"
          title="YouTube video player"
          frameborder="0"
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
          referrerpolicy="strict-origin-when-cross-origin"
          allowfullscreen
        ></iframe>
      </div>

      <!-- Text with processed links -->
      <div id="postCore" class="max-w-prose">
        <p class="ml-2 pt-2 whitespace-normal break-words text-sm sm:text-base">
          <span v-for="(part, index) in splitTextWithLinks" :key="index">
            <span
              v-if="part.isLink"
              @click="scrollToElement(part.id)"
              @mouseover="showPostPreview($event, part.id)"
              @mouseleave="hidePostPreview"
              class="text-twitch hover:underline cursor-pointer"
              >{{ '#' + part.text.slice(13, 21) }}</span
            >

            <div :data-post-text="index" v-else class="whitespace-normal break-words markdown">
              <vue-showdown :markdown="part.text" />
            </div>
          </span>
        </p>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 ml-4 mt-2">
      <div v-for="reply in props.replies" :key="reply.id">
        <p
          class="cursor-pointer hover:text-twitch"
          @click="repl(reply)"
          @mouseover="showPostPreview($event, reply)"
          @mouseleave="hidePostPreview"
        >
          #{{ reply ? reply.slice(13, 20) : '' }}
        </p>
      </div>
    </div>

  <!-- Tooltip –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å hoverPost –∏ —ç—Ç–æ –Ω–µ –º–æ–±–∏–ª—å–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ -->
  <div
    v-if="hoverPost && !isMobile"
    :style="{ top: tooltipPosition.top + 'px', left: tooltipPosition.left + 'px' }"
    class="fixed bg-black dark:bg-twitch text-white p-2 rounded-2xl shadow-lg max-w-md z-50"
  >
    <!-- –í–µ—Ä—Ö–Ω—è—è —á–∞—Å—Ç—å –≤—Å–ø–ª—ã–≤–∞—é—â–µ–≥–æ –æ–∫–Ω–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –ø–æ—Å—Ç–µ -->
    <div class="flex flex-wrap gap-1">
      <p>{{ hoverPost.theme }}</p>
      <p>{{ hoverPost.name }}</p>
      <p>{{ hoverPost.passcode }}</p>
      <p>{{ hoverPost.time }}</p>
      <p>{{ hoverPost.data }}</p>
      <p>#{{ hoverPost.postId.slice(12, 20) }}</p>
    </div>

    <!-- –¢–µ–∫—Å—Ç –ø–æ—Å—Ç–∞ -->
    <div>      
      <p class="pl-4 pt-2 pb-2">{{ hoverPost.text }}</p>
    </div>
  </div>
  </div>
</template>